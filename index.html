<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Avalia√ß√£o de Desempenho</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f2f2f2; }
    header { padding: 20px; background: linear-gradient(90deg, #0066cc, #33ccff); color: white; text-align: center; }
    .tabs { display: flex; justify-content: center; background: #ddd; padding: 10px; }
    .tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; color: #333; border-bottom: 3px solid transparent; }
    .tabs button.active { border-color: #0066cc; color: #0066cc; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    .card { background: white; padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .status { padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; color: white; }
    .status.complete { background: #28a745; }
    .status.pendente-gestor { background: #ffc107; color: black; }
    .status.pendente-colab { background: #dc3545; }
    .competencia { margin-top: 15px; padding: 15px; background: #f0f0f0; border-radius: 6px; }
    .assinatura { font-family: 'Brush Script MT', cursive; font-size: 1.6em; background: linear-gradient(to right, #8E2DE2, #4A00E0, #00C9FF, #92FE9D); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; color: transparent; animation: gradientMove 6s linear infinite; background-size: 300% 100%; text-align: center; }
    @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    footer { text-align: center; padding: 30px 10px; font-size: 0.85em; color: #999; background: #fff; }
    .debug-info { 
      background: #f8f9fa; 
      border: 1px solid #ddd; 
      padding: 10px; 
      margin: 10px 0; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 12px; 
      max-width: 100%;
      overflow-x: auto;
      word-wrap: break-word;
    }
    .loading { display: none; text-align: center; padding: 20px; color: #0066cc; }
    .error { color: #dc3545; font-weight: bold; }
    .success { color: #28a745; font-weight: bold; }
    .info-box { 
      background: #e3f2fd; 
      border-left: 4px solid #2196f3; 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 4px; 
      font-size: 14px; 
      line-height: 1.5;
    }
    .btn-custom {
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-custom:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .card-header { flex-direction: column; gap: 10px; }
      .competencia label, .competencia button { 
        display: block; 
        width: 100%; 
        margin: 5px 0 !important; 
        text-align: center;
        box-sizing: border-box;
      }
      .tabs { flex-wrap: wrap; }
      .tabs button { flex: 1; min-width: 120px; }
      .debug-info { font-size: 10px; }
      .info-box { font-size: 13px; padding: 10px; }
      header h1 { font-size: 1.5em; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Painel de Avalia√ß√£o de Desempenho</h1>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="colaborador">Colaborador</button>
    <button class="tab-btn" data-tab="equipe">Equipe/Fun√ß√£o</button>
  </div>

  <div id="colaborador" class="tab-content active">
    <div class="card">
      <div class="card-header">
        <strong>Importar Equipe:</strong> Envie o PDF com nomes e fun√ß√µes para gerar os cards automaticamente.
      </div>
      
      <div class="info-box">
        <strong>üìÑ Formato de PDF Compat√≠vel:</strong><br/>
        ‚Ä¢ <strong>Workday:</strong> Relat√≥rios de organograma/estrutura da equipe<br/>
        ‚Ä¢ <strong>Estrutura esperada:</strong> Nome do colaborador seguido da fun√ß√£o/cargo<br/>
        ‚Ä¢ <strong>Exemplo:</strong> "Jo√£o Silva" ‚Üí "Preparador Operador CNC"<br/>
        ‚Ä¢ <strong>Formatos suportados:</strong> Listas de colaboradores, organigramas, relat√≥rios de RH
      </div>
      
      <div class="competencia">
        <label for="pdfEquipe" class="btn-custom" style="display:inline-block; background:#0066cc; color:#fff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-right: 10px;">üìÑ Carregar PDF da Equipe</label>
        <button id="testeExemplo" class="btn-custom" style="background:#28a745; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-right: 10px;">üß™ Teste com Dados de Exemplo</button>
        <button id="limparDados" class="btn-custom" style="background:#dc3545; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">üóëÔ∏è Limpar Dados</button>
        <input type="file" id="pdfEquipe" accept="application/pdf" style="display:none;" />
        <div id="uploadFeedback" style="margin-top: 10px; font-weight:bold; color:#0066cc; opacity:0; transition:opacity 1s;"></div>
        <div class="loading" id="loading">
          <p>‚è≥ Processando PDF...</p>
        </div>
        <div id="debugInfo" class="debug-info" style="display: none;"></div>
      </div>
    </div>
    <div id="cardsContainer"></div>
  </div>

  <div id="equipe" class="tab-content">
    <div class="card">
      <div class="card-header">
        <strong>Resumo Equipe:</strong> Comparativo de compet√™ncias e status de preenchimento.
      </div>
      <div class="competencia">
        <canvas id="graficoRadar" width="400" height="400"></canvas>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Painel de Avalia√ß√£o - Todos os direitos reservados.<br/>
  </footer>

  <script>
    // Fun√ß√£o para mostrar feedback
    function showFeedback(message, type = 'info') {
      const feedback = document.getElementById('uploadFeedback');
      feedback.innerText = message;
      feedback.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#0066cc';
      feedback.style.opacity = '1';
      
      setTimeout(() => {
        feedback.style.opacity = '0';
      }, type === 'error' ? 5000 : 3000);
    }

    // Fun√ß√£o para mostrar informa√ß√µes de debug (com limite de tamanho)
    function showDebug(info) {
      const debugDiv = document.getElementById('debugInfo');
      
      // Truncar se muito longo
      let debugContent = info;
      if (info.length > 2000) {
        debugContent = info.substring(0, 2000) + '...<br/><em>(Debug truncado - veja o console para informa√ß√µes completas)</em>';
      }
      
      debugDiv.innerHTML = `<strong>üîç Informa√ß√µes de Debug:</strong><br/>${debugContent}`;
      debugDiv.style.display = 'block';
    }

    // Fun√ß√£o para mostrar loading
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // Configura√ß√£o das abas
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Verificar se PDF.js est√° carregado
    function checkPdfJs() {
      if (typeof pdfjsLib === 'undefined') {
        showFeedback('‚ùå Erro: PDF.js n√£o foi carregado corretamente', 'error');
        return false;
      }
      return true;
    }

    // Clique no label para abrir o input
    document.querySelector('label[for="pdfEquipe"]').addEventListener('click', (e) => {
      e.preventDefault();
      if (!checkPdfJs()) return;
      document.getElementById('pdfEquipe').click();
    });

    // Processamento do arquivo PDF
    document.getElementById('pdfEquipe').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading(true);
      showFeedback('Iniciando processamento do PDF...', 'info');

      try {
        console.log('Arquivo selecionado:', file.name, 'Tamanho:', file.size, 'bytes');
        
        // Verificar se √© realmente um PDF
        if (file.type !== 'application/pdf') {
          throw new Error('O arquivo selecionado n√£o √© um PDF v√°lido');
        }

        // Converter arquivo para ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        console.log('ArrayBuffer criado, tamanho:', arrayBuffer.byteLength);
        
        showFeedback('Carregando PDF...', 'info');
        
        // Carregar o PDF
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        console.log('PDF carregado. N√∫mero de p√°ginas:', pdf.numPages);
        
        showFeedback(`PDF carregado (${pdf.numPages} p√°ginas). Extraindo texto...`, 'info');

        let fullText = '';
        let debugInfo = `P√°ginas encontradas: ${pdf.numPages}<br/>`;

        // Extrair texto de todas as p√°ginas
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items.map(item => item.str);
          const pageText = strings.join(' ');
          fullText += pageText + '\n';
          
          debugInfo += `P√°gina ${i}: ${strings.length} elementos de texto<br/>`;
          console.log(`P√°gina ${i}:`, strings.slice(0, 10)); // Mostrar primeiros 10 itens
        }

        console.log("TEXTO COMPLETO EXTRA√çDO:");
        console.log(fullText);
        
        debugInfo += `<br/>Texto total extra√≠do: ${fullText.length} caracteres<br/>`;
        showDebug(debugInfo);

        // Processar o texto extra√≠do - Formato espec√≠fico do Workday
        const lines = fullText.split('\n').map(l => l.trim()).filter(l => l);
        console.log('Linhas processadas:', lines.slice(0, 30)); // Mostrar primeiras 30 linhas
        
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';
        let encontrouColaboradores = false;
        let colaboradoresEncontrados = [];

        // Parser espec√≠fico para relat√≥rios do Workday
        function parseWorkdayReport(lines) {
          const colaboradores = [];
          const ignorarLinhas = [
            'A partir de:', 'P√°gina', 'workday', 'Jundia√≠', 'Prep.Op.CNC...', 
            'Rogerio Ramos:', '(30)', 'Lider Processo Usi...', 'Employee Machining'
          ];
          
          for (let i = 0; i < lines.length; i++) {
            const linha = lines[i];
            
            // Ignorar linhas de cabe√ßalho, numera√ß√£o e localiza√ß√£o
            if (ignorarLinhas.some(ignore => linha.includes(ignore)) || 
                linha.match(/^\d+$/) || 
                linha === 'Jundia√≠' || 
                linha.length < 3) {
              continue;
            }
            
            // Identificar nomes (come√ßam com letra mai√∫scula e cont√™m espa√ßo ou t√™m mais de 5 caracteres)
            if ((linha.includes(' ') && /^[A-Z√Å√ä√ç√î√ö]/.test(linha)) || 
                (linha.length > 5 && /^[A-Z√Å√ä√ç√î√ö]/.test(linha) && /[a-z]/.test(linha))) {
              
              // Procurar a fun√ß√£o na pr√≥xima linha v√°lida
              for (let j = i + 1; j < Math.min(i + 4, lines.length); j++) {
                const proximaLinha = lines[j];
                
                // Se a pr√≥xima linha √© uma fun√ß√£o v√°lida
                if (proximaLinha && 
                    proximaLinha !== 'Jundia√≠' && 
                    !proximaLinha.match(/^\d+$/) &&
                    !ignorarLinhas.some(ignore => proximaLinha.includes(ignore)) &&
                    proximaLinha.length > 3) {
                  
                  // Verificar se n√£o √© outro nome
                  const ehOutroNome = /^[A-Z√Å√ä√ç√î√ö][a-z]+ [A-Z√Å√ä√ç√î√ö]/.test(proximaLinha);
                  
                  if (!ehOutroNome) {
                    colaboradores.push({ 
                      nome: linha, 
                      funcao: proximaLinha,
                      linha: i 
                    });
                    i = j; // Pular para depois da fun√ß√£o
                    break;
                  }
                }
              }
            }
          }
          
          return colaboradores;
        }

        // Usar o parser espec√≠fico do Workday
        colaboradoresEncontrados = parseWorkdayReport(lines);
        
        // Se ainda n√£o encontrou, tentar padr√£o alternativo
        if (colaboradoresEncontrados.length === 0) {
          // Regex para capturar padr√µes nome-fun√ß√£o espec√≠ficos
          const texto = lines.join('\n');
          const matches = texto.match(/([A-Z√Å√ä√ç√î√ö][a-z√°√™√≠√¥√∫]+ [A-Z√Å√ä√ç√î√ö][a-z√°√™√≠√¥√∫]+[^.\n]*)\n([A-Z][a-z]+\.[A-Z][a-z]+\.[A-Z][A-Z][A-Z].*|Operador.*|Aprendiz|Employee.*)/g);
          
          if (matches) {
            matches.forEach(match => {
              const partes = match.split('\n');
              if (partes.length >= 2) {
                colaboradoresEncontrados.push({
                  nome: partes[0].trim(),
                  funcao: partes[1].trim(),
                  linha: 0
                });
              }
            });
          }
        }

        console.log('Colaboradores encontrados:', colaboradoresEncontrados);

        // Fun√ß√£o para limpar e normalizar os dados
        function limparDados(colaboradores) {
          return colaboradores.map(colab => {
            let nome = colab.nome
              .replace(/\.\.\./g, '') // Remover retic√™ncias
              .replace(/\s+/g, ' ') // Normalizar espa√ßos
              .trim();
            
            let funcao = colab.funcao
              .replace(/\.\.\./g, '') // Remover retic√™ncias
              .replace(/Prep\.Op\./g, 'Preparador Operador ') // Expandir abrevia√ß√µes
              .replace(/CNC Multifu\.\.\./g, 'CNC Multifuncional')
              .replace(/Torno Vertica\.\.\./g, 'Torno Vertical')
              .replace(/Mandrilhador\.\.\./g, 'Mandrilhadora')
              .replace(/\s+/g, ' ') // Normalizar espa√ßos
              .trim();
            
            return { nome, funcao, linha: colab.linha };
          })
          .filter(colab => 
            colab.nome.length > 2 && 
            colab.funcao.length > 2 && 
            colab.nome !== colab.funcao // Evitar duplicatas
          );
        }

        // Limpar e filtrar os dados
        colaboradoresEncontrados = limparDados(colaboradoresEncontrados);

        // Remover duplicatas baseado no nome
        const colaboradoresUnicos = [];
        const nomesVistos = new Set();
        
        colaboradoresEncontrados.forEach(colab => {
          const nomeNormalizado = colab.nome.toLowerCase().replace(/[^a-z]/g, '');
          if (!nomesVistos.has(nomeNormalizado)) {
            nomesVistos.add(nomeNormalizado);
            colaboradoresUnicos.push(colab);
          }
        });

        colaboradoresEncontrados = colaboradoresUnicos;

    // Fun√ß√£o para criar cards de colaboradores
    function criarCards(colaboradores) {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      
      colaboradores.forEach((colab, index) => {
        const id = colab.nome.toLowerCase().replace(/[^a-z0-9]/g, '-');
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = id;
        card.innerHTML = `
          <div class="card-header">
            <div><strong>Colaborador:</strong> ${colab.nome}<br/><strong>Fun√ß√£o:</strong> ${colab.funcao}</div>
            <div class="status">Avalia√ß√£o n√£o iniciada</div>
          </div>
          <div class="competencia"><em>Nenhuma avalia√ß√£o registrada.</em></div>
        `;
        container.appendChild(card);
      });
    }

    // Bot√£o de teste com dados de exemplo
    document.getElementById('testeExemplo').addEventListener('click', () => {
      const exemploColaboradores = [
        { nome: 'Rogerio Ramos', funcao: 'Lider Processo Usinagem' },
        { nome: 'Adilson Goncalves', funcao: 'Preparador Operador CNC Multifuncional' },
        { nome: 'Alexandre Domingues', funcao: 'Preparador Operador CNC Multifuncional' },
        { nome: 'Aluisio Martins', funcao: 'Operador M√°quina' },
        { nome: 'Amilton Patera', funcao: 'Preparador Operador CNC Multifuncional' },
        { nome: 'Antonio Francisco', funcao: 'Preparador Operador CNC Multifuncional' },
        { nome: 'Gabriel Borssatto', funcao: 'Preparador Operador Torno Vertical' },
        { nome: 'Gustavo Henrique', funcao: 'Aprendiz' },
        { nome: 'Jonathan de Melo', funcao: 'Operador CNC Multifuncional' },
        { nome: 'Juliano de Almeida', funcao: 'Preparador Operador Mandrilhadora' },
        { nome: 'Lucas Augusto', funcao: 'Operador CNC Multifuncional' },
        { nome: 'Raildo Xavier', funcao: 'Furador Radial' },
        { nome: 'Samuel Ferreira', funcao: 'Operador M√°quina' },
        { nome: 'Vinicius Diniz Leal', funcao: 'Aprendiz' }
      ];
      
      criarCards(exemploColaboradores);
      showFeedback(`‚úÖ Dados de exemplo carregados! ${exemploColaboradores.length} colaboradores.`, 'success');
    });

    // Bot√£o para limpar dados
    document.getElementById('limparDados').addEventListener('click', () => {
      document.getElementById('cardsContainer').innerHTML = '';
      document.getElementById('debugInfo').style.display = 'none';
      showFeedback('üóëÔ∏è Dados limpos com sucesso!', 'info');
    });

        showLoading(false);

        if (encontrouColaboradores) {
          showFeedback(`‚úÖ Equipe carregada com sucesso! ${colaboradoresEncontrados.length} colaborador(es) encontrado(s).`, 'success');
          
          // Mostrar preview dos colaboradores encontrados no debug
          const preview = colaboradoresEncontrados.slice(0, 5).map(c => 
            `‚Ä¢ ${c.nome} ‚Üí ${c.funcao}`
          ).join('<br/>');
          const totalInfo = colaboradoresEncontrados.length > 5 ? 
            `<br/><em>... e mais ${colaboradoresEncontrados.length - 5} colaboradores</em>` : '';
          
          showDebug(debugInfo + `<br/><strong>‚úÖ Colaboradores encontrados (primeiros 5):</strong><br/>${preview}${totalInfo}`);
        } else {
          showFeedback('‚ö†Ô∏è Nenhum colaborador encontrado no PDF. Verifique o formato do arquivo.', 'error');
          const linhasPreview = lines.slice(0, 15).join('<br/>').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          showDebug(debugInfo + `<br/><strong>‚ùå Primeiras 15 linhas do texto extra√≠do:</strong><br/>${linhasPreview}`);
        }

      } catch (error) {
        showLoading(false);
        console.error('Erro ao processar PDF:', error);
        showFeedback(`‚ùå Erro ao processar PDF: ${error.message}`, 'error');
        showDebug(`Erro detalhado: ${error.message}<br/>Stack: ${error.stack}`);
      }

      // Limpar o input para permitir recarregar o mesmo arquivo
      event.target.value = '';
    });

    // Verificar se PDF.js carregou corretamente ao iniciar
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (checkPdfJs()) {
          console.log('PDF.js carregado com sucesso');
        }
      }, 1000);
    });
  </script>
</body>
</html>
